<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Options Leaders</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;
      --line2:#d1d5db;
      --blue:#1d4ed8;
      --blue2:#2563eb;
      --blueSoft:#eff6ff;
      --green:#059669;
      --red:#dc2626;
      --amber:#d97706;
      --shadow: 0 8px 24px rgba(17, 24, 39, 0.08);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--text);
      background:var(--bg);
    }

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:20;
      background:#0b1220;
      color:#e5e7eb;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .topbar .wrap{
      max-width: 1280px;
      margin:0 auto;
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:700; letter-spacing:.2px;
    }
    .brand .logo{
      width:28px; height:28px; border-radius:8px;
      background: linear-gradient(135deg, #1d4ed8, #60a5fa);
      display:inline-block;
      box-shadow: 0 8px 20px rgba(29,78,216,.35);
    }
    .topmeta{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      font-size:12px; color:#cbd5e1;
    }
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      border-radius: 999px;
      white-space:nowrap;
    }
    .chip strong{color:#fff}

    /* Page header + tabs */
    .wrap{max-width:1280px; margin:0 auto; padding:16px}
    .pageHead{
      display:flex; justify-content:space-between; align-items:flex-end; gap:16px; flex-wrap:wrap;
      margin-top:6px;
    }
    h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .sub a{color:var(--blue); text-decoration:none}
    .sub a:hover{text-decoration:underline}

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:12px;
    }
    .tab{
      font-size:12px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--card);
      color: var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: var(--blueSoft);
      color: var(--blue);
      border-color: #c7d2fe;
      font-weight:650;
    }

    /* Controls panel */
    .panel{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-top:12px;
      overflow:hidden;
    }
    .panel .hd{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(#ffffff, #fafafa);
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .panel .hd .title{
      font-size:13px;
      font-weight:700;
      display:flex; gap:10px; align-items:center;
    }
    .pill{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color: var(--muted);
      background:#fff;
    }
    .panel .bd{padding:12px}

    .controls{
      display:grid;
      grid-template-columns: 1.2fr .7fr .7fr .7fr .7fr .6fr;
      gap:10px;
    }
    @media (max-width: 1100px){
      .controls{grid-template-columns: 1fr 1fr 1fr}
    }
    @media (max-width: 720px){
      .controls{grid-template-columns: 1fr}
    }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, button{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--line2);
      background:#fff;
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    input::placeholder{color:#9ca3af}
    input:focus, select:focus{
      border-color:#93c5fd;
      box-shadow: 0 0 0 3px rgba(147,197,253,.35);
    }
    .btnrow{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .btn{
      width:auto;
      background: var(--blue);
      color:#fff;
      border-color: var(--blue);
      font-weight:650;
      cursor:pointer;
    }
    .btn:hover{background:var(--blue2); border-color:var(--blue2)}
    .btn.secondary{
      background:#fff; color:var(--blue);
      border-color:#c7d2fe;
    }
    .btn.secondary:hover{background:var(--blueSoft)}
    .btn.ghost{
      background:#fff; color:var(--text);
      border-color: var(--line);
      font-weight:600;
    }

    /* KPI strip */
    .kpis{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 1100px){ .kpis{grid-template-columns: repeat(3, 1fr)} }
    @media (max-width: 720px){ .kpis{grid-template-columns: repeat(2, 1fr)} }
    .kpi{
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      padding:10px 12px;
    }
    .kpi .k{font-size:11px; color:var(--muted)}
    .kpi .v{margin-top:6px; font-size:18px; font-weight:800; font-family: var(--mono)}
    .kpi .s{margin-top:6px; font-size:11px; color:var(--muted)}

    /* Table */
    .tableWrap{
      margin-top:12px;
      background:#fff;
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .tableTop{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;
      background: linear-gradient(#ffffff, #fafafa);
    }
    .tableTop .left{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      font-size:12px; color:var(--muted);
    }
    .tableTop .right{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .smallSelect{padding:8px 10px; font-size:12px}
    .smallInput{padding:8px 10px; font-size:12px}

    table{width:100%; border-collapse:collapse; min-width: 1100px}
    thead th{
      position:sticky; top:0;
      background:#fff;
      border-bottom:1px solid var(--line2);
      color:#111827;
      font-size:12px;
      text-align:left;
      padding:10px 10px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      font-size:12px;
      color:#111827;
      vertical-align:top;
      white-space:nowrap;
    }
    tbody tr:nth-child(even){background:#fbfbfd}
    tbody tr:hover{background: #f1f5ff}
    .right{text-align:right}
    .mono{font-family: var(--mono)}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:11px;
      color:var(--muted);
      background:#fff;
    }
    .dot{width:7px;height:7px;border-radius:999px;background:#9ca3af}
    .dot.g{background:var(--green)}
    .dot.r{background:var(--red)}
    .dot.a{background:var(--amber)}

    .sig{
      font-weight:800;
      font-family: var(--mono);
      font-variant-numeric: tabular-nums;
    }
    .sig.g{color:var(--green)}
    .sig.r{color:var(--red)}
    .sig.a{color:var(--amber)}

    .muted{color:var(--muted)}
    .wrapScroll{overflow:auto}

    /* Density */
    body.compact tbody td, body.compact thead th{padding:7px 8px}
    body.compact tbody td{font-size:11px}
    body.compact thead th{font-size:11px}

    .err{
      margin-top:10px;
      padding:10px 12px;
      border:1px solid #fecaca;
      background:#fff1f2;
      color:#991b1b;
      border-radius:12px;
      font-family: var(--mono);
      font-size:12px;
      white-space:pre-wrap;
      display:none;
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="wrap">
      <div class="brand">
        <span class="logo"></span>
        <span>Options Dashboard</span>
      </div>
      <div class="topmeta">
        <span class="chip">Rows <strong id="rowsAll">0</strong></span>
        <span class="chip">Showing <strong id="rowsShown">0</strong></span>
        <span class="chip">Updated <strong id="loadedAt">—</strong></span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="pageHead">
      <div>
        <h1>Options Leaders</h1>
        <div class="sub">
          CSV source:
          <a id="srcLink" href="#" target="_blank" rel="noreferrer">TODAY.csv</a>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Views">
        <div class="tab active" id="tab-leaders">Leaders</div>
        <div class="tab" id="tab-setups">Setups</div>
        <div class="tab" id="tab-risk">Risk</div>
        <div class="tab" id="tab-rules">Rules</div>
      </div>
    </div>

    <div class="panel">
      <div class="hd">
        <div class="title">
          Filters
          <span class="pill" id="hintPill">Ranked by Signal</span>
        </div>
        <div class="muted" style="font-size:12px">
          Tip: click a column header to sort
        </div>
      </div>

      <div class="bd">
        <div class="controls">
          <div>
            <label>Search</label>
            <input id="q" placeholder="ticker, setup_type, symbols, entry_rule…" />
          </div>
          <div>
            <label>Ticker</label>
            <select id="ticker"><option value="">All</option></select>
          </div>
          <div>
            <label>Spread</label>
            <select id="spread"><option value="">All</option></select>
          </div>
          <div>
            <label>Setup type</label>
            <select id="setupType"><option value="">All</option></select>
          </div>
          <div>
            <label>Setup</label>
            <select id="setupOnly">
              <option value="yes" selected>YES only</option>
              <option value="no">All rows</option>
            </select>
          </div>
          <div>
            <label>Status</label>
            <select id="status"><option value="">All</option></select>
          </div>

          <div>
            <label>Min Edge</label>
            <input id="minEdge" type="number" step="0.01" value="-1.00" />
          </div>
          <div>
            <label>Min POP</label>
            <input id="minPop" type="number" step="0.01" value="0.00" />
          </div>
          <div>
            <label>DTE ≤</label>
            <input id="maxDte" type="number" step="1" value="9999" />
          </div>
          <div>
            <label>Rank by</label>
            <select id="rankBy">
              <option value="signal" selected>Signal</option>
              <option value="edge">Edge</option>
              <option value="pop">POP</option>
              <option value="spread_mid">Spread Mid</option>
              <option value="dte">DTE</option>
            </select>
          </div>
          <div>
            <label>Rows per page</label>
            <select id="pageSize">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
          <div>
            <label>Density</label>
            <select id="density">
              <option value="comfortable" selected>Comfortable</option>
              <option value="compact">Compact</option>
            </select>
          </div>
        </div>

        <div class="btnrow">
          <button class="btn" id="reload">Reload</button>
          <button class="btn secondary" id="download">Download filtered CSV</button>
          <button class="btn ghost" id="copyLink">Copy share link</button>
          <button class="btn ghost" id="reset">Reset filters</button>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="k">Strong (≥80)</div>
            <div class="v" id="kStrong">0</div>
            <div class="s">signal bucket</div>
          </div>
          <div class="kpi">
            <div class="k">Watch (60–79)</div>
            <div class="v" id="kWatch">0</div>
            <div class="s">signal bucket</div>
          </div>
          <div class="kpi">
            <div class="k">Avoid (&lt;60)</div>
            <div class="v" id="kAvoid">0</div>
            <div class="s">signal bucket</div>
          </div>
          <div class="kpi">
            <div class="k">Avg Edge</div>
            <div class="v" id="kEdge">0.000</div>
            <div class="s">filtered view</div>
          </div>
          <div class="kpi">
            <div class="k">Avg POP</div>
            <div class="v" id="kPop">0.000</div>
            <div class="s">filtered view</div>
          </div>
        </div>

        <div class="err" id="err"></div>
      </div>
    </div>

    <div class="tableWrap">
      <div class="tableTop">
        <div class="left">
          <span class="badge"><span class="dot g"></span>Strong</span>
          <span class="badge"><span class="dot a"></span>Watch</span>
          <span class="badge"><span class="dot r"></span>Avoid</span>
          <span class="muted" id="sortNote"></span>
        </div>
        <div class="right">
          <button class="btn ghost" id="prev">Prev</button>
          <span class="mono muted" id="pageNote">Page 1</span>
          <button class="btn ghost" id="next">Next</button>
        </div>
      </div>

      <div class="wrapScroll">
        <table>
          <thead><tr id="thead"></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="sub" style="margin-top:12px">
      This page is a lightweight, self-contained dashboard (no external JS libs). It reads the published
      <span class="mono">tables/TODAY.csv</span> file and provides filters + sorting + pagination.
    </div>
  </div>

<script>
(() => {
  // Your live CSV
  const DEFAULT_URL = "https://raw.githubusercontent.com/aglucaci/options/refs/heads/main/tables/TODAY.csv";

  const $ = (id) => document.getElementById(id);

  const state = {
    url: DEFAULT_URL,
    rows: [],
    sort: { key: "signal", dir: "desc" },
    page: 1,
    pageSize: 25,
    activeTab: "leaders"
  };

  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function toNum(v){
    if (v == null) return null;
    const s = String(v).trim();
    if (!s) return null;
    const cleaned = s.replace(/[$,%]/g,"").replace(/,/g,"");
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : null;
  }
  function parseCSV(text){
    const rows = [];
    let i=0, field="", row=[], inQ=false;
    while (i < text.length){
      const c = text[i];
      if (inQ){
        if (c === '"' && text[i+1] === '"'){ field+='"'; i+=2; continue; }
        if (c === '"'){ inQ=false; i++; continue; }
        field += c; i++; continue;
      } else {
        if (c === '"'){ inQ=true; i++; continue; }
        if (c === ','){ row.push(field); field=""; i++; continue; }
        if (c === '\r'){ i++; continue; }
        if (c === '\n'){ row.push(field); rows.push(row); row=[]; field=""; i++; continue; }
        field += c; i++; continue;
      }
    }
    if (field.length || row.length){ row.push(field); rows.push(row); }
    if (!rows.length) return { headers: [], data: [] };

    const headers = rows[0].map(h => h.trim());
    const data = rows.slice(1)
      .filter(r => r.some(x => String(x||"").trim() !== ""))
      .map(r => {
        const o = {};
        headers.forEach((h, idx) => o[h] = (r[idx] ?? "").trim());
        return o;
      });
    return { headers, data };
  }

  // Composite signal tailored to your schema (fast scan):
  // + edge, + pop, small penalty for big spread_mid and long dte
  function computeSignal(r){
    const edge = toNum(r.edge) ?? 0;
    const pop  = toNum(r.pop) ?? 0;
    const mid  = toNum(r.spread_mid) ?? 0;
    const dte  = toNum(r.dte) ?? 0;

    const edgeScore = Math.max(-1, Math.min(1, edge / 0.25));       // +/-0.25 edge -> +/-1
    const popScore  = (Math.max(0, Math.min(1, pop)) * 2) - 1;      // 0..1 -> -1..+1
    const midScore  = -Math.max(0, Math.min(1, mid / 3.0));         // 0..3 -> 0..-1
    const dteScore  = -Math.max(0, Math.min(1, dte / 90.0));        // 0..90 -> 0..-1

    const raw = 0.50*edgeScore + 0.34*popScore + 0.10*midScore + 0.06*dteScore;
    return Math.round(50 + 50 * Math.max(-1, Math.min(1, raw)));
  }

  function bucket(sig){
    if (sig >= 80) return "g";
    if (sig >= 60) return "a";
    return "r";
  }

  function uniq(arr){
    return [...new Set(arr.filter(v => String(v ?? "").trim() !== ""))].sort();
  }

  function setSelectOptions(){
    const tick = uniq(state.rows.map(r => r.ticker));
    const spr  = uniq(state.rows.map(r => r.spread));
    const stp  = uniq(state.rows.map(r => r.setup_type));
    const stat = uniq(state.rows.map(r => r.status));

    const fill = (sel, values) => {
      const cur = sel.value;
      sel.innerHTML = `<option value="">All</option>` + values.map(v => `<option value="${esc(v)}">${esc(v)}</option>`).join("");
      if (values.includes(cur)) sel.value = cur;
    };
    fill($("ticker"), tick);
    fill($("spread"), spr);
    fill($("setupType"), stp);
    fill($("status"), stat);
  }

  function getFilters(){
    return {
      q: $("q").value.trim().toLowerCase(),
      ticker: $("ticker").value.trim(),
      spread: $("spread").value.trim(),
      setupType: $("setupType").value.trim(),
      status: $("status").value.trim(),
      setupOnly: $("setupOnly").value === "yes",
      minEdge: Number($("minEdge").value || -1e9),
      minPop: Number($("minPop").value || -1e9),
      maxDte: Number($("maxDte").value || 999999),
      rankBy: $("rankBy").value,
      pageSize: Number($("pageSize").value || 25),
      density: $("density").value
    };
  }

  function tabColumns(){
    // “Barchart-like”: show a concise, leaderboard-focused set per tab
    const base = ["ticker","spread","setup_type","Setup","status","signal"];
    if (state.activeTab === "leaders"){
      return base.concat(["edge","pop","spread_mid","dte","exp_date","long_strike","short_strike"]);
    }
    if (state.activeTab === "setups"){
      return base.concat(["Reason","entry_rule","exit_rule","setup_ok","ema21_invalidation"]);
    }
    if (state.activeTab === "risk"){
      return base.concat(["breakeven","max_profit","max_loss","spread_delta","spread_theta","spread_vega"]);
    }
    // rules
    return base.concat(["entry_rule","exit_rule","tp_spread_px","sl_spread_px","time_stop_days","take_profit_frac"]);
  }

  function applyFilters(){
    const f = getFilters();
    state.pageSize = f.pageSize;

    document.body.classList.toggle("compact", f.density === "compact");

    let out = state.rows;

    if (f.setupOnly) out = out.filter(r => String(r.Setup||"").toUpperCase() === "YES");
    if (f.ticker) out = out.filter(r => r.ticker === f.ticker);
    if (f.spread) out = out.filter(r => r.spread === f.spread);
    if (f.setupType) out = out.filter(r => r.setup_type === f.setupType);
    if (f.status) out = out.filter(r => (r.status || "") === f.status);

    out = out.filter(r => (toNum(r.edge) ?? -1e9) >= f.minEdge);
    out = out.filter(r => (toNum(r.pop)  ?? -1e9) >= f.minPop);
    out = out.filter(r => (toNum(r.dte)  ?? 0) <= f.maxDte);

    if (f.q){
      const keys = ["ticker","spread","setup_type","Reason","entry_rule","exit_rule","long_symbol","short_symbol","status"];
      out = out.filter(r => keys.some(k => String(r[k] ?? "").toLowerCase().includes(f.q)));
    }

    // sort
    const key = f.rankBy;
    const dir = state.sort.key === key ? state.sort.dir : "desc";
    out = [...out].sort((a,b) => {
      let av = (key === "signal") ? a.signal : toNum(a[key]);
      let bv = (key === "signal") ? b.signal : toNum(b[key]);
      if (av != null && bv != null) return dir === "asc" ? av-bv : bv-av;
      const as = String(a[key] ?? "");
      const bs = String(b[key] ?? "");
      return dir === "asc" ? as.localeCompare(bs) : bs.localeCompare(as);
    });

    // pagination clamp
    const totalPages = Math.max(1, Math.ceil(out.length / state.pageSize));
    if (state.page > totalPages) state.page = totalPages;
    if (state.page < 1) state.page = 1;

    return { out, totalPages };
  }

  function renderKPIs(view){
    const sigs = view.map(r => r.signal ?? 0);
    const strong = sigs.filter(s => s >= 80).length;
    const watch  = sigs.filter(s => s >= 60 && s < 80).length;
    const avoid  = sigs.filter(s => s < 60).length;

    const edges = view.map(r => toNum(r.edge)).filter(v => v != null);
    const pops  = view.map(r => toNum(r.pop)).filter(v => v != null);

    const avg = (arr) => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : 0;

    $("kStrong").textContent = String(strong);
    $("kWatch").textContent  = String(watch);
    $("kAvoid").textContent  = String(avoid);
    $("kEdge").textContent   = avg(edges).toFixed(3);
    $("kPop").textContent    = avg(pops).toFixed(3);
  }

  function renderTable(view, totalPages){
    const cols = tabColumns();
    const head = $("thead");
    const body = $("tbody");
    head.innerHTML = "";
    body.innerHTML = "";

    cols.forEach(c => {
      const th = document.createElement("th");
      th.textContent = c;
      th.onclick = () => {
        const sortKey = (c === "signal") ? "signal" : c;
        if (state.sort.key === sortKey) state.sort.dir = (state.sort.dir === "asc" ? "desc" : "asc");
        else { state.sort.key = sortKey; state.sort.dir = "desc"; }
        $("rankBy").value = (["signal","edge","pop","spread_mid","dte"].includes(sortKey)) ? sortKey : "signal";
        render();
      };
      head.appendChild(th);
    });

    const start = (state.page - 1) * state.pageSize;
    const pageRows = view.slice(start, start + state.pageSize);

    pageRows.forEach(r => {
      const tr = document.createElement("tr");
      cols.forEach(c => {
        const td = document.createElement("td");

        if (c === "signal"){
          const sig = r.signal ?? 0;
          const b = bucket(sig);
          td.innerHTML = `<span class="sig ${b}">${sig}</span>`;
          td.className = "right";
        } else if (c === "Setup"){
          const v = String(r.Setup || "").toUpperCase();
          td.innerHTML = v === "YES"
            ? `<span class="badge"><span class="dot g"></span>YES</span>`
            : `<span class="badge"><span class="dot r"></span>NO</span>`;
        } else if (c === "status"){
          const v = String(r.status || "").toLowerCase();
          const b = (v === "ok") ? "g" : (v ? "a" : "r");
          td.innerHTML = `<span class="badge"><span class="dot ${b}"></span>${esc(r.status || "")}</span>`;
        } else {
          const n = toNum(r[c]);
          if (n != null && ["edge","pop","spread_mid","dte","breakeven","max_profit","max_loss","spread_delta","spread_theta","spread_vega","tp_spread_px","sl_spread_px","take_profit_frac"].includes(c)){
            td.textContent = (c === "dte" || c === "time_stop_days") ? String(Math.round(n)) : n.toFixed(3).replace(/\.?0+$/,"");
            td.className = "right mono";
          } else {
            // long text fields: keep readable but compact
            if (["entry_rule","exit_rule","Reason"].includes(c)){
              td.innerHTML = `<span class="muted">${esc(r[c] || "")}</span>`;
            } else {
              td.textContent = r[c] ?? "";
            }
            if (["ticker","spread","setup_type","exp_date","long_symbol","short_symbol"].includes(c)) td.classList.add("mono");
          }
        }
        tr.appendChild(td);
      });
      body.appendChild(tr);
    });

    $("pageNote").textContent = `Page ${state.page} / ${totalPages}`;
  }

  function updateMeta(totalRows, shownRows){
    $("rowsAll").textContent = String(totalRows);
    $("rowsShown").textContent = String(shownRows);
    $("loadedAt").textContent = new Date().toLocaleString();
    $("sortNote").textContent = `Sorted by ${state.sort.key} (${state.sort.dir})`;
    $("hintPill").textContent = `Ranked by ${$("rankBy").value.toUpperCase()}`;
  }

  function showErr(msg){
    const box = $("err");
    box.style.display = "block";
    box.textContent = msg;
  }
  function clearErr(){
    const box = $("err");
    box.style.display = "none";
    box.textContent = "";
  }

  function makeShareLink(){
    const f = getFilters();
    const p = new URLSearchParams();
    p.set("q", f.q);
    if (f.ticker) p.set("t", f.ticker);
    if (f.spread) p.set("s", f.spread);
    if (f.setupType) p.set("u", f.setupType);
    if (f.status) p.set("st", f.status);
    p.set("so", f.setupOnly ? "1" : "0");
    p.set("me", String(f.minEdge));
    p.set("mp", String(f.minPop));
    p.set("md", String(f.maxDte));
    p.set("rb", f.rankBy);
    p.set("ps", String(f.pageSize));
    p.set("dn", f.density);
    p.set("tab", state.activeTab);
    const u = new URL(window.location.href);
    u.search = p.toString();
    return u.toString();
  }

  function applyFromQueryString(){
    const p = new URLSearchParams(window.location.search);
    if (p.has("q")) $("q").value = p.get("q") || "";
    if (p.has("t")) $("ticker").value = p.get("t") || "";
    if (p.has("s")) $("spread").value = p.get("s") || "";
    if (p.has("u")) $("setupType").value = p.get("u") || "";
    if (p.has("st")) $("status").value = p.get("st") || "";
    if (p.has("so")) $("setupOnly").value = (p.get("so")==="1") ? "yes" : "no";
    if (p.has("me")) $("minEdge").value = p.get("me") || "-1";
    if (p.has("mp")) $("minPop").value = p.get("mp") || "0";
    if (p.has("md")) $("maxDte").value = p.get("md") || "9999";
    if (p.has("rb")) $("rankBy").value = p.get("rb") || "signal";
    if (p.has("ps")) $("pageSize").value = p.get("ps") || "25";
    if (p.has("dn")) $("density").value = p.get("dn") || "comfortable";
    if (p.has("tab")) setTab(p.get("tab") || "leaders", true);
  }

  function downloadFiltered(rows){
    const cols = tabColumns(); // download current view columns (tab-based)
    const header = cols.join(",");
    const lines = [header];
    rows.forEach(r => {
      const row = cols.map(c => {
        let v = (c === "signal") ? String(r.signal ?? "") : String(r[c] ?? "");
        if (v.includes('"') || v.includes(",") || v.includes("\n")) v = `"${v.replace(/"/g,'""')}"`;
        return v;
      });
      lines.push(row.join(","));
    });
    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `TODAY_filtered_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function setTab(tab, skipRender){
    state.activeTab = tab;

    const map = {
      "leaders": $("tab-leaders"),
      "setups": $("tab-setups"),
      "risk": $("tab-risk"),
      "rules": $("tab-rules")
    };
    Object.entries(map).forEach(([k, el]) => el.classList.toggle("active", k === tab));

    if (!skipRender) render();
  }

  async function load(){
    clearErr();
    $("srcLink").href = state.url;
    $("srcLink").textContent = state.url;

    const r = await fetch(state.url, { cache: "no-store" });
    if (!r.ok) throw new Error(`Fetch failed: HTTP ${r.status}`);
    const text = await r.text();
    const { data } = parseCSV(text);
    if (!data.length) throw new Error("CSV appears empty or could not be parsed.");

    state.rows = data.map(o => ({ ...o, signal: computeSignal(o) }));
    setSelectOptions();
    $("rowsAll").textContent = String(state.rows.length);
  }

  function render(){
    clearErr();
    const { out, totalPages } = applyFilters();
    const view = out; // filtered+sorted full set; table paginates inside renderTable

    renderKPIs(view);
    renderTable(view, totalPages);
    updateMeta(state.rows.length, view.length);
  }

  // Wiring
  const inputs = ["q","ticker","spread","setupType","setupOnly","status","minEdge","minPop","maxDte","rankBy","pageSize","density"];
  inputs.forEach(id => {
    $(id).addEventListener("input", () => { state.page = 1; render(); });
    $(id).addEventListener("change", () => { state.page = 1; render(); });
  });

  $("prev").onclick = () => { state.page = Math.max(1, state.page - 1); render(); };
  $("next").onclick = () => { state.page = state.page + 1; render(); };

  $("reload").onclick = async () => {
    try { await load(); applyFromQueryString(); render(); }
    catch(e){ showErr(String(e && e.stack ? e.stack : e)); }
  };

  $("download").onclick = () => {
    const { out } = applyFilters();
    downloadFiltered(out);
  };

  $("copyLink").onclick = async () => {
    const link = makeShareLink();
    try { await navigator.clipboard.writeText(link); }
    catch { prompt("Copy link:", link); }
  };

  $("reset").onclick = () => {
    $("q").value = "";
    $("ticker").value = "";
    $("spread").value = "";
    $("setupType").value = "";
    $("status").value = "";
    $("setupOnly").value = "yes";
    $("minEdge").value = "-1.00";
    $("minPop").value = "0.00";
    $("maxDte").value = "9999";
    $("rankBy").value = "signal";
    $("pageSize").value = "25";
    $("density").value = "comfortable";
    state.page = 1;
    setTab("leaders", true);
    render();
  };

  $("tab-leaders").onclick = () => setTab("leaders");
  $("tab-setups").onclick  = () => setTab("setups");
  $("tab-risk").onclick    = () => setTab("risk");
  $("tab-rules").onclick   = () => setTab("rules");

  // Init
  (async () => {
    try{
      await load();
      applyFromQueryString();
      render();
    } catch(e){
      showErr(String(e && e.stack ? e.stack : e));
    }
  })();

})();
</script>
</body>
</html>
