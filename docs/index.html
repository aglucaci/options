<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Options TODAY — Signal Dashboard</title>
  <style>
    :root{
      --bg:#0b0f17; --panel:#0f1626; --panel2:#101a2e; --muted:#8aa0c6; --text:#e8eefc;
      --line:#1d2a44; --accent:#7aa2ff; --good:#2ee59d; --warn:#ffd166; --bad:#ff5c7c;
      --shadow: 0 10px 35px rgba(0,0,0,.35); --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(122,162,255,.20), transparent 60%),
        radial-gradient(900px 600px at 110% 10%, rgba(46,229,157,.12), transparent 50%),
        var(--bg);
      color:var(--text); font-family:var(--sans);
    }
    header{
      padding:20px 18px 10px; position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,15,23,.92), rgba(11,15,23,.74));
      border-bottom:1px solid rgba(29,42,68,.85);
    }
    .wrap{max-width:1280px; margin:0 auto}
    .titlebar{display:flex; gap:14px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap}
    h1{margin:0; font-size:18px; letter-spacing:.2px}
    .sub{margin:6px 0 0; color:var(--muted); font-size:12px}
    .pillrow{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{
      font-size:12px; color:var(--muted);
      padding:6px 10px; border:1px solid rgba(29,42,68,.9);
      background:rgba(15,22,38,.55);
      border-radius:999px;
    }
    .pill strong{color:var(--text); font-weight:650}
    main{padding:14px 18px 34px}
    .grid{display:grid; gap:12px}
    @media (min-width: 1050px){
      .grid{grid-template-columns: 1.1fr .9fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(15,22,38,.86), rgba(15,22,38,.66));
      border:1px solid rgba(29,42,68,.95);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 12px 10px;
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      border-bottom:1px solid rgba(29,42,68,.7);
      background: linear-gradient(180deg, rgba(16,26,46,.65), transparent);
    }
    .card .hd h2{margin:0; font-size:13px; color:#dbe7ff; letter-spacing:.2px}
    .card .bd{padding:12px}
    .controls{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 860px){ .controls{grid-template-columns:1fr} }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, button{
      width:100%;
      background:rgba(16,26,46,.55);
      border:1px solid rgba(29,42,68,.95);
      color:var(--text);
      padding:10px 10px;
      border-radius: 12px;
      outline:none;
    }
    input::placeholder{color:rgba(138,160,198,.75)}
    button{cursor:pointer; transition: transform .05s ease, border-color .15s ease}
    button:hover{border-color: rgba(122,162,255,.65)}
    button:active{transform: translateY(1px)}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap}
    .btnrow button{width:auto; padding:10px 12px; font-size:12px}
    .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    @media (max-width: 1050px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{
      padding:12px;
      border-radius: 14px;
      background:rgba(16,26,46,.45);
      border:1px solid rgba(29,42,68,.8);
    }
    .kpi .k{color:var(--muted); font-size:12px}
    .kpi .v{margin-top:6px; font-size:18px; font-weight:700; letter-spacing:.2px; font-family: var(--mono)}
    .kpi .s{margin-top:6px; font-size:11px; color:var(--muted)}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(29,42,68,.9); background:rgba(16,26,46,.45);
      font-size:12px; color:var(--muted);
    }
    .dot{width:8px; height:8px; border-radius:999px; background:var(--muted)}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .tablewrap{
      border-radius: 14px;
      overflow:auto;
      border:1px solid rgba(29,42,68,.8);
      background:rgba(11,15,23,.35);
    }
    table{width:100%; border-collapse:collapse; min-width: 980px}
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(29,42,68,.65);
      font-size:12px;
      white-space:nowrap;
      vertical-align:top;
    }
    th{
      position:sticky; top:0;
      background: rgba(15,22,38,.92);
      color:#dbe7ff;
      cursor:pointer;
      user-select:none;
    }
    td{color:rgba(232,238,252,.92)}
    tr:hover td{background: rgba(122,162,255,.06)}
    .mono{font-family: var(--mono)}
    .muted{color:var(--muted)}
    .right{text-align:right}
    .rank{font-family: var(--mono); font-weight:800; color:#dbe7ff}
    .sig{font-family: var(--mono); font-variant-numeric: tabular-nums}
    .sig.good{color:var(--good)}
    .sig.warn{color:var(--warn)}
    .sig.bad{color:var(--bad)}
    .pillSm{
      display:inline-block; padding:2px 8px; border-radius:999px;
      border:1px solid rgba(29,42,68,.8); background:rgba(16,26,46,.35);
      color:var(--muted); font-size:11px;
    }
    .footer{margin-top:12px; color:var(--muted); font-size:12px}
    .spark{
      width:100%; height:220px;
      border-radius: 12px;
      border:1px solid rgba(29,42,68,.8);
      background: rgba(16,26,46,.35);
      padding:8px;
    }
    .err{color: var(--bad); font-family: var(--mono); font-size:12px; white-space:pre-wrap}
    .tiny{font-size:11px}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 900px){ .grid2{grid-template-columns:1fr} }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="titlebar">
      <div>
        <h1>Options TODAY — Signal Dashboard</h1>
        <div class="sub">
          CSV: <span class="mono" id="src"></span>
        </div>
      </div>
      <div class="pillrow">
        <span class="pill"><strong id="rowsP">0</strong> rows</span>
        <span class="pill">Filtered <strong id="rowsF">0</strong></span>
        <span class="pill">Loaded <strong id="loadedAt">—</strong></span>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap grid">
    <!-- LEFT: table -->
    <section class="card">
      <div class="hd">
        <h2>Signal Board</h2>
        <div class="pillrow">
          <span class="badge"><span class="dot good"></span>Strong</span>
          <span class="badge"><span class="dot warn"></span>Watch</span>
          <span class="badge"><span class="dot bad"></span>Avoid</span>
        </div>
      </div>
      <div class="bd">
        <div class="controls">
          <div>
            <label>Search (ticker / symbols / rules / reason)</label>
            <input id="q" placeholder="e.g., SPY, pullback, EMA21, QQQ…" />
          </div>

          <div>
            <label>Ticker</label>
            <select id="ticker">
              <option value="">All</option>
            </select>
          </div>

          <div>
            <label>Spread</label>
            <select id="spread">
              <option value="">All</option>
            </select>
          </div>

          <div>
            <label>Setup type</label>
            <select id="setupType">
              <option value="">All</option>
            </select>
          </div>

          <div class="grid2">
            <div>
              <label>Setup = YES (default)</label>
              <select id="setupOnly">
                <option value="yes" selected>YES only</option>
                <option value="no">All rows</option>
              </select>
            </div>
            <div>
              <label>Status</label>
              <select id="status">
                <option value="">All</option>
              </select>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>Min Edge</label>
              <input id="minEdge" type="number" step="0.01" value="0.00" />
            </div>
            <div>
              <label>Min POP</label>
              <input id="minPop" type="number" step="0.01" value="0.00" />
            </div>
          </div>

          <div>
            <label>Show</label>
            <select id="topN">
              <option value="25">Top 25</option>
              <option value="50" selected>Top 50</option>
              <option value="100">Top 100</option>
              <option value="999999">All</option>
            </select>
          </div>

          <div>
            <label>Rank by</label>
            <select id="rankBy">
              <option value="signal" selected>Signal (composite)</option>
              <option value="edge">Edge</option>
              <option value="pop">POP</option>
              <option value="bs_spread">BS Spread</option>
              <option value="spread_mid">Spread Mid</option>
              <option value="dte">DTE</option>
            </select>
          </div>
        </div>

        <div class="btnrow" style="margin-top:10px">
          <button id="reload">Reload CSV</button>
          <button id="copyLink">Copy share link</button>
          <button id="download">Download filtered CSV</button>
        </div>

        <div style="margin-top:12px" class="tablewrap">
          <table>
            <thead><tr id="thead"></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="footer">
          “Signal” is a modern composite optimized for fast scanning: it rewards higher <span class="mono">edge</span> and <span class="mono">pop</span>,
          and lightly penalizes higher <span class="mono">spread_mid</span> and longer <span class="mono">dte</span>.
          Tune filters above to match your execution constraints.
        </div>

        <div id="err" class="err"></div>
      </div>
    </section>

    <!-- RIGHT: insights + plots -->
    <aside class="card">
      <div class="hd">
        <h2>High-Signal Insights</h2>
        <span class="badge"><span class="dot good"></span><span id="insightLabel">Live</span></span>
      </div>
      <div class="bd">
        <div class="kpis">
          <div class="kpi">
            <div class="k">Strong</div>
            <div class="v" id="kStrong">0</div>
            <div class="s">Signal ≥ 80</div>
          </div>
          <div class="kpi">
            <div class="k">Watch</div>
            <div class="v" id="kWatch">0</div>
            <div class="s">60–79</div>
          </div>
          <div class="kpi">
            <div class="k">Avoid</div>
            <div class="v" id="kAvoid">0</div>
            <div class="s">&lt; 60</div>
          </div>
          <div class="kpi">
            <div class="k">Avg Signal</div>
            <div class="v" id="kAvg">0.0</div>
            <div class="s">in filtered view</div>
          </div>
        </div>

        <div style="margin-top:12px" class="card" style="box-shadow:none">
          <div class="hd"><h2>Edge vs POP (bubble = |edge|)</h2></div>
          <div class="bd">
            <canvas id="scatter" class="spark"></canvas>
            <div class="footer tiny muted" id="scatterNote"></div>
          </div>
        </div>

        <div style="margin-top:12px" class="card" style="box-shadow:none">
          <div class="hd"><h2>Top 10 by signal</h2></div>
          <div class="bd">
            <div class="tablewrap">
              <table style="min-width: 0">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Ticker</th>
                    <th>Spread</th>
                    <th class="right">Signal</th>
                    <th class="right">Edge</th>
                    <th class="right">POP</th>
                  </tr>
                </thead>
                <tbody id="top10"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div style="margin-top:12px" class="footer muted">
          Raw CSV endpoint is ideal for embedding in other dashboards and automations.
        </div>
      </div>
    </aside>
  </div>
</main>

<script>
(() => {
  // Update this if your raw URL changes
  const DEFAULT_URL = "https://raw.githubusercontent.com/aglucaci/options/refs/heads/main/tables/TODAY.csv";

  const $ = (id) => document.getElementById(id);

  const state = {
    url: DEFAULT_URL,
    rows: [],
    cols: [],
    sort: { col: "signal", dir: "desc" },
  };

  function toNum(v){
    if (v == null) return null;
    const s = String(v).trim();
    if (!s) return null;
    const cleaned = s.replace(/[$,%]/g,"").replace(/,/g,"");
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : null;
  }

  // Robust CSV parser (handles quotes)
  function parseCSV(text){
    const rows = [];
    let i=0, field="", row=[], inQ=false;
    while (i < text.length){
      const c = text[i];
      if (inQ){
        if (c === '"' && text[i+1] === '"'){ field+='"'; i+=2; continue; }
        if (c === '"'){ inQ=false; i++; continue; }
        field += c; i++; continue;
      } else {
        if (c === '"'){ inQ=true; i++; continue; }
        if (c === ','){ row.push(field); field=""; i++; continue; }
        if (c === '\r'){ i++; continue; }
        if (c === '\n'){ row.push(field); rows.push(row); row=[]; field=""; i++; continue; }
        field += c; i++; continue;
      }
    }
    if (field.length || row.length){ row.push(field); rows.push(row); }
    if (!rows.length) return { headers: [], data: [] };

    const headers = rows[0].map(h => h.trim());
    const data = rows.slice(1)
      .filter(r => r.some(x => String(x||"").trim() !== ""))
      .map(r => {
        const o = {};
        headers.forEach((h, idx) => o[h] = (r[idx] ?? "").trim());
        return o;
      });
    return { headers, data };
  }

  // Composite signal tuned to your schema:
  // + edge (higher better), + pop (higher better)
  // - spread_mid (higher capital at risk / cost), - dte (longer tie-up)
  // For credit spreads, negative spread_mid isn't expected here; still works.
  function computeSignal(r){
    const edge = toNum(r.edge) ?? 0;
    const pop  = toNum(r.pop) ?? 0;
    const mid  = toNum(r.spread_mid) ?? 0;
    const dte  = toNum(r.dte) ?? 0;

    // Map typical ranges to comparable scale:
    // edge: assume roughly [-0.5..+0.5] in practice -> emphasize
    const edgeScore = Math.max(-1, Math.min(1, edge / 0.25)); // +/-0.25 -> +/-1
    // pop: roughly [0..1]
    const popScore = Math.max(0, Math.min(1, pop)) * 2 - 1;   // 0..1 -> -1..+1
    // mid: penalize large debit/credit magnitude; assume 0..5 typical
    const midScore = -Math.max(0, Math.min(1, mid / 3.0));    // 0..3 -> 0..-1
    // dte: penalize long tie-up; assume 0..120 typical
    const dteScore = -Math.max(0, Math.min(1, dte / 90.0));   // 0..90 -> 0..-1

    // weights: edge > pop > mid > dte
    const raw = 0.48*edgeScore + 0.34*popScore + 0.12*midScore + 0.06*dteScore;

    // Convert raw [-1..+1] approx -> [0..100]
    const sig = Math.round(50 + 50 * Math.max(-1, Math.min(1, raw)));
    return sig;
  }

  function classify(sig){
    if (sig >= 80) return "good";
    if (sig >= 60) return "warn";
    return "bad";
  }

  function uniqueSorted(values){
    return [...new Set(values.filter(v => v != null && String(v).trim() !== ""))].sort();
  }

  function setOptions(){
    // ticker/spread/setupType/status
    const tick = uniqueSorted(state.rows.map(r => r.ticker));
    const spr  = uniqueSorted(state.rows.map(r => r.spread));
    const stp  = uniqueSorted(state.rows.map(r => r.setup_type));
    const stat = uniqueSorted(state.rows.map(r => r.status));

    const fill = (sel, arr) => {
      const cur = sel.value;
      sel.innerHTML = `<option value="">All</option>` + arr.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
      if (arr.includes(cur)) sel.value = cur;
    };

    fill($("ticker"), tick);
    fill($("spread"), spr);
    fill($("setupType"), stp);
    fill($("status"), stat);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function getFilters(){
    return {
      q: $("q").value.trim().toLowerCase(),
      ticker: $("ticker").value.trim(),
      spread: $("spread").value.trim(),
      setupType: $("setupType").value.trim(),
      status: $("status").value.trim(),
      setupOnly: $("setupOnly").value === "yes",
      minEdge: Number($("minEdge").value || 0),
      minPop: Number($("minPop").value || 0),
      topN: Number($("topN").value),
      rankBy: $("rankBy").value,
    };
  }

  function applyFilters(){
    const f = getFilters();
    let out = state.rows;

    if (f.setupOnly) out = out.filter(r => (r.Setup || "").toUpperCase() === "YES");
    if (f.ticker) out = out.filter(r => r.ticker === f.ticker);
    if (f.spread) out = out.filter(r => r.spread === f.spread);
    if (f.setupType) out = out.filter(r => r.setup_type === f.setupType);
    if (f.status) out = out.filter(r => (r.status || "") === f.status);

    out = out.filter(r => (toNum(r.edge) ?? -1e9) >= f.minEdge);
    out = out.filter(r => (toNum(r.pop) ?? -1e9) >= f.minPop);

    if (f.q){
      out = out.filter(r => {
        // search key fields first
        const keys = ["ticker","spread","setup_type","Reason","entry_rule","exit_rule","long_symbol","short_symbol","status"];
        for (const k of keys){
          if (String(r[k] ?? "").toLowerCase().includes(f.q)) return true;
        }
        return false;
      });
    }

    // sorting
    const col = f.rankBy;
    const dir = state.sort.col === col ? state.sort.dir : "desc";
    out = [...out].sort((a,b) => {
      let av, bv;

      if (col === "signal"){ av = a.signal; bv = b.signal; }
      else av = toNum(a[col]);
      if (col !== "signal") bv = toNum(b[col]);

      if (av != null && bv != null) return dir === "asc" ? av - bv : bv - av;
      const as = String(a[col] ?? "");
      const bs = String(b[col] ?? "");
      return dir === "asc" ? as.localeCompare(bs) : bs.localeCompare(as);
    });

    // topN
    if (Number.isFinite(f.topN) && f.topN < out.length) out = out.slice(0, f.topN);

    return out;
  }

  function buildTable(view){
    const head = $("thead");
    const body = $("tbody");
    head.innerHTML = "";
    body.innerHTML = "";

    // curated display columns (modern, high-signal)
    const cols = [
      "__rank",
      "ticker",
      "spread",
      "setup_type",
      "Setup",
      "status",
      "signal",
      "edge",
      "pop",
      "spread_mid",
      "dte",
      "exp_date",
      "long_strike",
      "short_strike",
      "tp_spread_px",
      "sl_spread_px",
      "entry_rule",
      "exit_rule"
    ];

    // header with sorting
    cols.forEach(c => {
      const th = document.createElement("th");
      th.textContent = (c === "__rank") ? "#" : c;
      th.onclick = () => {
        const sortKey = c === "__rank" ? "signal" : c;
        if (state.sort.col === sortKey) state.sort.dir = (state.sort.dir === "asc" ? "desc" : "asc");
        else { state.sort.col = sortKey; state.sort.dir = "desc"; }
        // keep selector aligned if user clicks header
        if (sortKey === "signal") $("rankBy").value = "signal";
        else if (["edge","pop","bs_spread","spread_mid","dte"].includes(sortKey)) $("rankBy").value = sortKey;
        render();
      };
      head.appendChild(th);
    });

    // body
    view.forEach((r, idx) => {
      const tr = document.createElement("tr");

      cols.forEach(c => {
        const td = document.createElement("td");

        if (c === "__rank"){
          td.textContent = String(idx+1);
          td.className = "rank";
        } else if (c === "signal"){
          const sig = r.signal ?? 0;
          td.textContent = String(sig);
          td.className = `sig ${classify(sig)} right`;
        } else if (c === "Setup"){
          const v = (r.Setup || "").toUpperCase();
          td.innerHTML = v === "YES" ? `<span class="pillSm">YES</span>` : `<span class="pillSm">NO</span>`;
        } else if (c === "status"){
          const v = (r.status || "").toLowerCase();
          const cls = v === "ok" ? "good" : (v ? "warn" : "bad");
          td.innerHTML = `<span class="sig ${cls}">${escapeHtml(r.status || "")}</span>`;
        } else if (c === "edge" || c === "pop" || c === "spread_mid" || c === "dte" ||
                   c === "tp_spread_px" || c === "sl_spread_px" || c === "long_strike" || c === "short_strike"){
          const n = toNum(r[c]);
          td.textContent = (n == null) ? "" : (c === "dte" ? String(Math.round(n)) : n.toFixed(3).replace(/\.?0+$/,""));
          td.className = "right mono";
        } else if (c === "entry_rule" || c === "exit_rule"){
          td.innerHTML = `<span class="tiny">${escapeHtml(r[c] || "")}</span>`;
        } else {
          td.textContent = r[c] ?? "";
          if (c === "exp_date") td.classList.add("mono");
          if (c === "ticker" || c === "spread" || c === "setup_type") td.classList.add("mono");
        }

        tr.appendChild(td);
      });

      body.appendChild(tr);
    });
  }

  function renderKPIs(view){
    const sigs = view.map(r => r.signal ?? 0);
    const strong = sigs.filter(s => s >= 80).length;
    const watch  = sigs.filter(s => s >= 60 && s < 80).length;
    const avoid  = sigs.filter(s => s < 60).length;
    const avg = sigs.length ? sigs.reduce((a,b)=>a+b,0)/sigs.length : 0;

    $("kStrong").textContent = String(strong);
    $("kWatch").textContent  = String(watch);
    $("kAvoid").textContent  = String(avoid);
    $("kAvg").textContent    = avg.toFixed(1);

    // top10 list
    const top = [...view].sort((a,b) => (b.signal??0) - (a.signal??0)).slice(0,10);
    const tb = $("top10");
    tb.innerHTML = "";
    top.forEach((r,i) => {
      const sig = r.signal ?? 0;
      const cls = classify(sig);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${i+1}</td>
        <td class="mono">${escapeHtml(r.ticker||"")}</td>
        <td class="mono">${escapeHtml(r.spread||"")}</td>
        <td class="right sig ${cls}">${sig}</td>
        <td class="right mono">${(toNum(r.edge)==null?"":toNum(r.edge).toFixed(3).replace(/\.?0+$/,""))}</td>
        <td class="right mono">${(toNum(r.pop)==null?"":toNum(r.pop).toFixed(3).replace(/\.?0+$/,""))}</td>
      `;
      tb.appendChild(tr);
    });
  }

  // Simple canvas scatter: x=POP, y=EDGE, bubble=|edge|
  function renderScatter(view){
    const canvas = $("scatter");
    const ctx = canvas.getContext("2d");
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    ctx.clearRect(0,0,rect.width,rect.height);

    const pts = view
      .map(r => ({ pop: toNum(r.pop), edge: toNum(r.edge), sig: r.signal ?? 0, t: r.ticker || "" }))
      .filter(p => p.pop != null && p.edge != null);

    if (!pts.length){
      $("scatterNote").textContent = "No points (need numeric edge and pop).";
      return;
    }

    // bounds
    const xMin = 0, xMax = 1; // pop in [0,1] typically
    let yMin = Math.min(...pts.map(p=>p.edge));
    let yMax = Math.max(...pts.map(p=>p.edge));
    if (yMin === yMax){ yMin -= 0.1; yMax += 0.1; }
    const pad = 34;
    const w = rect.width - pad*2;
    const h = rect.height - pad*2;

    function xScale(x){ return pad + w * ((x - xMin) / (xMax - xMin)); }
    function yScale(y){ return pad + h * (1 - (y - yMin) / (yMax - yMin)); }

    // axes/grid
    ctx.strokeStyle = "rgba(29,42,68,.8)";
    ctx.lineWidth = 1;
    for (let i=0;i<=4;i++){
      const y = pad + h*(i/4);
      ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(pad+w, y); ctx.stroke();
    }
    for (let i=0;i<=4;i++){
      const x = pad + w*(i/4);
      ctx.beginPath(); ctx.moveTo(x, pad); ctx.lineTo(x, pad+h); ctx.stroke();
    }

    // zero-line for edge
    if (yMin < 0 && yMax > 0){
      const y0 = yScale(0);
      ctx.strokeStyle = "rgba(122,162,255,.55)";
      ctx.beginPath(); ctx.moveTo(pad, y0); ctx.lineTo(pad+w, y0); ctx.stroke();
    }

    // points
    pts.forEach(p => {
      const x = xScale(Math.max(xMin, Math.min(xMax, p.pop)));
      const y = yScale(p.edge);

      // bubble radius based on |edge|
      const r = 3 + 10 * Math.min(1, Math.abs(p.edge) / 0.25);

      // color by signal
      const cls = classify(p.sig);
      let fill = "rgba(138,160,198,.55)";
      if (cls === "good") fill = "rgba(46,229,157,.70)";
      else if (cls === "warn") fill = "rgba(255,209,102,.70)";
      else fill = "rgba(255,92,124,.65)";

      ctx.fillStyle = fill;
      ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    });

    // labels
    ctx.fillStyle = "rgba(232,238,252,.85)";
    ctx.font = "12px " + getComputedStyle(document.documentElement).getPropertyValue('--mono');
    ctx.fillText("POP →", pad + w - 46, rect.height - 12);
    ctx.save();
    ctx.translate(12, pad + 18);
    ctx.rotate(-Math.PI/2);
    ctx.fillText("EDGE →", 0, 0);
    ctx.restore();

    $("scatterNote").textContent = `Y-range edge: [${yMin.toFixed(3)}, ${yMax.toFixed(3)}] • N=${pts.length}`;
  }

  function makeShareLink(){
    const f = getFilters();
    const p = new URLSearchParams();
    p.set("q", f.q);
    if (f.ticker) p.set("t", f.ticker);
    if (f.spread) p.set("s", f.spread);
    if (f.setupType) p.set("u", f.setupType);
    if (f.status) p.set("st", f.status);
    p.set("so", f.setupOnly ? "1" : "0");
    p.set("me", String(f.minEdge));
    p.set("mp", String(f.minPop));
    p.set("n", String(f.topN));
    p.set("r", f.rankBy);
    const u = new URL(window.location.href);
    u.search = p.toString();
    return u.toString();
  }

  function applyFromQueryString(){
    const p = new URLSearchParams(window.location.search);
    if (p.has("q")) $("q").value = p.get("q") || "";
    if (p.has("t")) $("ticker").value = p.get("t") || "";
    if (p.has("s")) $("spread").value = p.get("s") || "";
    if (p.has("u")) $("setupType").value = p.get("u") || "";
    if (p.has("st")) $("status").value = p.get("st") || "";
    if (p.has("so")) $("setupOnly").value = (p.get("so")==="1") ? "yes" : "no";
    if (p.has("me")) $("minEdge").value = p.get("me") || "0";
    if (p.has("mp")) $("minPop").value = p.get("mp") || "0";
    if (p.has("n")) $("topN").value = p.get("n") || "50";
    if (p.has("r")) $("rankBy").value = p.get("r") || "signal";
  }

  function downloadFiltered(view){
    const cols = Object.keys(state.rows[0] || {});
    const want = ["ticker","spread","setup_type","Setup","status","edge","pop","spread_mid","dte","exp_date","long_strike","short_strike","tp_spread_px","sl_spread_px","entry_rule","exit_rule"];
    const header = ["signal", ...want.filter(c => cols.includes(c))];

    const lines = [header.join(",")];
    view.forEach(r => {
      const row = header.map(c => {
        let v = "";
        if (c === "signal") v = String(r.signal ?? "");
        else v = String(r[c] ?? "");
        if (v.includes('"') || v.includes(",") || v.includes("\n")) v = `"${v.replace(/"/g,'""')}"`;
        return v;
      });
      lines.push(row.join(","));
    });

    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `TODAY_filtered_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  async function load(){
    $("err").textContent = "";
    $("src").innerHTML = `<a href="${state.url}" target="_blank" rel="noreferrer">${state.url}</a>`;

    const r = await fetch(state.url, { cache: "no-store" });
    if (!r.ok) throw new Error(`Fetch failed: HTTP ${r.status}`);
    const text = await r.text();

    const { headers, data } = parseCSV(text);
    if (!headers.length || !data.length) throw new Error("CSV appears empty or could not be parsed.");

    // Normalize expected columns exist; keep as-is otherwise
    state.cols = headers;
    state.rows = data.map(o => {
      const r = { ...o };
      r.signal = computeSignal(r);
      return r;
    });

    $("rowsP").textContent = String(state.rows.length);
    setOptions();
  }

  function render(){
    const view = applyFilters();
    $("rowsF").textContent = String(view.length);

    buildTable(view);
    renderKPIs(view);
    renderScatter(view);

    $("loadedAt").textContent = new Date().toLocaleString();
    $("insightLabel").textContent = "Live";
  }

  // wiring
  const inputs = ["q","ticker","spread","setupType","setupOnly","status","minEdge","minPop","topN","rankBy"];
  inputs.forEach(id => {
    $(id).addEventListener("input", render);
    $(id).addEventListener("change", render);
  });

  $("reload").onclick = async () => {
    $("insightLabel").textContent = "Loading…";
    try { await load(); applyFromQueryString(); render(); }
    catch(e){ $("err").textContent = String(e && e.stack ? e.stack : e); $("insightLabel").textContent = "Error"; }
  };

  $("copyLink").onclick = async () => {
    const link = makeShareLink();
    try{
      await navigator.clipboard.writeText(link);
      $("insightLabel").textContent = "Link copied";
      setTimeout(()=> $("insightLabel").textContent = "Live", 1200);
    } catch {
      prompt("Copy link:", link);
    }
  };

  $("download").onclick = () => downloadFiltered(applyFilters());

  // init
  (async () => {
    try{
      await load();
      applyFromQueryString();
      render();
    } catch(e){
      $("err").textContent = String(e && e.stack ? e.stack : e);
      $("insightLabel").textContent = "Error";
    }
  })();

  // redraw scatter on resize
  let t=null;
  window.addEventListener("resize", () => { clearTimeout(t); t=setTimeout(render, 120); });

})();
</script>
</body>
</html>
